// [FILE: schema.prisma]

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // or "mysql" depending on your setup
  url      = env("DATABASE_URL")
}

// ==========================================
// ENUMS
// ==========================================

enum Role {
  super_admin
  sales
  accounting
  admin_hr
}

enum SelectionStatus {
  pending
  confirmed
  in_progress
  completed
  cancelled
}

// ==========================================
// USER & INQUIRY MANAGEMENT
// ==========================================

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  name          String
  mobile_number String?
  role          Role     @default(sales)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  inquiries_sold     Inquiry[]   @relation("SalesPerson")
  inquiries_involved Inquiry[]   @relation("InquiryMembers")
  inquiries_created  Inquiry[]   @relation("CreatedBy")
  selections_created Selection[] @relation("SelectionCreatedBy")
  quotations_created Quotation[]
  
  catalogMovements   CatalogMovement[]
  // === ADD THIS NEW LINE ===
  comments_made      InquiryComment[] 

  quotation_comments QuotationComment[]
  attendance         Attendance[]

  leaveRequests LeaveRequest[] // <--- ADD THIS LINE
  leaveBalance  LeaveBalance? // <--- ADD THIS
  corrections   TimeCorrection[] // <--- ADD THIS
}

model Inquiry {
  id                  String    @id @default(uuid())
  inquiry_number      String    @unique
  client_name         String
  architect_id_name   String?

  client_birth_date       DateTime?
  client_anniversary_date DateTime?

  mobile_number       String
  inquiry_date        DateTime  @default(now())
  address             String
  expected_final_date DateTime?
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt
  
  description         String?   @db.Text

  sales_person_id String
  sales_person    User   @relation("SalesPerson", fields: [sales_person_id], references: [id])
  
  sales_persons   User[] @relation("InquiryMembers")
  
  created_by_id String
  created_by    User   @relation("CreatedBy", fields: [created_by_id], references: [id])

  architectId   String?
  architect     Architect? @relation(fields: [architectId], references: [id])

  selections Selection[]

  // === ADD THESE NEW LINES ===
  stage       String    @default("Inquiry") // "Inquiry", "Quotation Submitted", "Ongoing", "Completed"
  priority    String    @default("Medium")  // "High", "Medium", "Low"
  
  comments    InquiryComment[]
  checklists  InquiryChecklist[]
  labels      InquiryLabel[]
  catalogMovements CatalogMovement[]
}
// ==========================================
// ATTENDANCE, HR & REPORTING MODELS
// ==========================================

model Attendance {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  
  date            DateTime  @default(now()) 
  
  // Time Tracking
  checkIn         DateTime  @default(now())
  checkOut        DateTime?
  lastPauseTime   DateTime? 
  totalBreakHours Float     @default(0)
  workingHours    Float?
  overtimeHours   Float     @default(0)
  
  // Compliance & Location
  isLate          Boolean   @default(false)
  latitude        Float?    // For field sales tracking
  longitude       Float?
  locationName    String?
  
  // Status: ACTIVE, PAUSED, COMPLETED, AUTO_CLOSED
  status          String    @default("ACTIVE") 
  
  // Draft Reports (Auto-saves during the day)
  draftTasks      String?   @db.Text
  draftWip        String?   @db.Text
  draftIssues     String?   @db.Text
  draftPending    String?   @db.Text

  // Final End-of-Day Reports
  reportTasks     String?   @db.Text
  reportWip       String?   @db.Text
  reportIssues    String?   @db.Text
  reportPending   String?   @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}


model LeaveRequest {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  type        String   // "Sick", "Casual", "Paid", "Unpaid"
  startDate   DateTime
  endDate     DateTime
  reason      String   @db.Text
  
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  reviewedBy  String?  // Admin ID who approved/rejected
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model LeaveBalance {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  casual    Float    @default(7)  // Yearly quotas
  sick      Float    @default(7)
  paid      Float    @default(15)
  
  updatedAt DateTime @updatedAt
}

model TimeCorrection {
  id                String    @id @default(uuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  date              DateTime
  requestedCheckIn  DateTime?
  requestedCheckOut DateTime?
  reason            String    @db.Text
  
  status            String    @default("PENDING") // PENDING, APPROVED, REJECTED
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// ==========================================
// PIPELINE / KANBAN MODELS (NEW)
// ==========================================

model InquiryComment {
  id        String   @id @default(uuid())
  content   String
  attachmentUrl String?

  createdAt DateTime @default(now())
  
  
  // Link to Inquiry
  inquiryId String
  inquiry   Inquiry  @relation(fields: [inquiryId], references: [id], onDelete: Cascade)
  
  // Link to User (Who wrote it)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
}

model InquiryChecklist {
  id        String   @id @default(uuid())
  title     String
  
  inquiryId String
  inquiry   Inquiry  @relation(fields: [inquiryId], references: [id], onDelete: Cascade)
  
  items     InquiryChecklistItem[]
}

model InquiryChecklistItem {
  id          String           @id @default(uuid())
  text        String
  isCompleted Boolean          @default(false)
  
  checklistId String
  checklist   InquiryChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
}

model InquiryLabel {
  id        String   @id @default(uuid())
  text      String
  color     String   // Stores hex code or tailwind class like "bg-red-500"
  
  inquiryId String
  inquiry   Inquiry  @relation(fields: [inquiryId], references: [id], onDelete: Cascade)
}


// === NEW MODEL ===
model Architect {
  id                  String    @id @default(uuid())
  name                String
  address             String?
  contact             String?
  email               String?
  birth_date          DateTime?
  anniversary_date    DateTime?
  associate_arch_name String?
  
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  inquiries           Inquiry[]
  catalogMovements    CatalogMovement[]
}


model InquiryCounter {
  id         String   @id @default(uuid())
  year_month String   @unique
  counter    Int      @default(0)
  created_at DateTime @default(now())
}

model DeepCalculation {
  id          String    @id @default(uuid())
  selectionId String    @unique
  selection   Selection @relation(fields: [selectionId], references: [id], onDelete: Cascade)

  items DeepCalculationItem[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}
model DeepCalculationItem {
  id                String          @id @default(uuid())
  deepCalculationId String
  deepCalculation   DeepCalculation @relation(fields: [deepCalculationId], references: [id], onDelete: Cascade)

  selectionItemId String
  selectionItem   SelectionItem @relation(fields: [selectionItemId], references: [id], onDelete: Cascade)

  category String @default("Local")
  
  variant          String   @default("Normal") // "Main", "Sheer", or "Normal"


  // Dimensions
  width  Float  @default(0)
  height Float  @default(0)
  unit   String @default("mm")

  // Quantities
  panna       Float @default(0)
  part        Float @default(1)
  channel     Float @default(0)
  fabric      Float @default(0)
  blackout    Float @default(0)
  sheer       Float @default(0)
  labour      Float @default(0)
  fitting     Float @default(0)
  weightChain Float @default(0)

  // Rates
  fabricRate   Float @default(0)
  blackoutRate Float @default(0)
  sheerRate    Float @default(0)
  channelRate  Float @default(285)
  labourRate   Float @default(450)
  fittingRate  Float @default(355)

  // Toggles (âœ… ADD THE MISSING ONES HERE)
  hasFabric   Boolean @default(true)   // <--- ADD THIS
  hasBlackout Boolean @default(false)
  hasSheer    Boolean @default(false)
  hasChannel  Boolean @default(true)   // <--- ADD THIS
  hasLabour   Boolean @default(true)   // <--- ADD THIS
  hasFitting  Boolean @default(true)   // <--- ADD THIS

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}


// [APPEND TO schema.prisma]

// ==========================================
// GPW CALCULATION (Gravel, Pulse, Weave)
// ==========================================

model GpwCalculation {
  id          String               @id @default(uuid())
  selectionId String               @unique
  selection   Selection            @relation(fields: [selectionId], references: [id], onDelete: Cascade)
  items       GpwCalculationItem[]
  created_at  DateTime             @default(now())
  updated_at  DateTime             @updatedAt
}

model GpwCalculationItem {
  id              String         @id @default(uuid())
  calculationId   String
  calculation     GpwCalculation @relation(fields: [calculationId], references: [id], onDelete: Cascade)

  selectionItemId String
  selectionItem   SelectionItem  @relation(fields: [selectionItemId], references: [id], onDelete: Cascade)

  // Type: Gravel, Pulse, Weave
  type            String         @default("Gravel") 

  // Dimensions
  rft             Float          @default(0)

  // Track (Channel)
  trackPrice      Float          @default(0)
  trackGst        Float          @default(0)
  trackFinal      Float          @default(0)

  // Motor
  motorPrice      Float          @default(0)
  motorGst        Float          @default(0)
  motorFinal      Float          @default(0)

  // Remote
  remotePrice     Float          @default(0)
  remoteGst       Float          @default(0)
  remoteFinal     Float          @default(0)
}
// ==========================================
// SELECTION MANAGEMENT
// ==========================================

model Selection {
  id               String  @id @default(uuid())
  selection_number String  @unique
  inquiryId        String
  inquiry          Inquiry @relation(fields: [inquiryId], references: [id])
  
  version          Int     @default(1)
  
  status         SelectionStatus @default(pending)
  selection_date DateTime        @default(now())
  delivery_date  DateTime?
  notes          String?
  items          SelectionItem[]

  created_by_id String
  created_by    User   @relation("SelectionCreatedBy", fields: [created_by_id], references: [id])

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // RELATIONS TO CALCULATIONS
  calculation       Calculation? // Legacy/Generic
  localCalculation  LocalCalculation? // Dedicated Local
  deepCalculation   DeepCalculation?
  forestCalculation ForestCalculation? // Dedicated Forest
  somfyCalculation  SomfyCalculation? // Dedicated Somfy (NEW)
  gpwCalculation    GpwCalculation?    // Dedicated GPW (NEW)
  quotations Quotation[]
}

// [FILE: schema.prisma]

model SelectionItem {
  id          String    @id @default(uuid())
  selectionId String
  selection   Selection @relation(fields: [selectionId], references: [id], onDelete: Cascade)

  orderIndex Int @default(0)

 
  version     Int       @default(1)
  
  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  productName String
  quantity    Float  @default(1)
  price       Float  @default(0)
  total       Float  @default(0)

  details Json?
  unit    String? @default("mm")
  width   Float?
  height  Float?

  // === ADD THIS NEW FIELD ===
  calculationType String @default("Local")
  // ==========================

  type             String?
  motorizationMode String?
  opsType          String?
  pelmet           Float?
  openingType      String?
  created_at       DateTime @default(now())

  // Relations to calculation items
  calculationItems CalculationItem[]
  localItems       LocalCalculationItem[]
  deepItems        DeepCalculationItem[]
  forestItems      ForestCalculationItem[]
  somfyItems       SomfyCalculationItem[]
  gpwItems         GpwCalculationItem[]
}

model SelectionCounter {
  id         String   @id @default(uuid())
  year_month String   @unique
  counter    Int      @default(0)
  created_at DateTime @default(now())
}

// ==========================================
// CATALOG MANAGEMENT
// ==========================================

model Company {
  id        String    @id @default(uuid())
  name      String    @unique
  logo      String?
  catalogs  Catalog[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Catalog {
  id        String    @id @default(uuid())
  name      String
  type      String?
  companyId String
  company   Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  products  Product[]
  copies    CatalogCopy[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([name, companyId])
}

model Product {
  id         String   @id @default(uuid())
  name       String
  catalogId  String
  catalog    Catalog  @relation(fields: [catalogId], references: [id], onDelete: Cascade)
  price      String
  imageUrl   String?
  attributes Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  selectionItems SelectionItem[]
}


// [APPEND TO schema.prisma]

// ==========================================
// CATALOGUE TRACKING SYSTEM
// ==========================================

model CatalogCopy {
  id          String   @id @default(uuid())
  catalogId   String
  catalog     Catalog  @relation(fields: [catalogId], references: [id], onDelete: Cascade)
  
  copyNumber  String   // e.g., "001", "002"
  status      String   @default("AVAILABLE") // "AVAILABLE", "ISSUED"
  
  createdAt   DateTime @default(now())
  
  movements   CatalogMovement[]
}

model CatalogMovement {
  id              String       @id @default(uuid())
  
  copyId          String
  copy            CatalogCopy  @relation(fields: [copyId], references: [id], onDelete: Cascade)
  
  // Issue Details
  inquiryId       String?      // The Project
  inquiry         Inquiry?     @relation(fields: [inquiryId], references: [id])
  
  architectId     String?
  architect       Architect?   @relation(fields: [architectId], references: [id])
  
  issuedByUserId  String
  issuedByUser    User         @relation(fields: [issuedByUserId], references: [id])
  
  clientName      String
  areaName        String?
  remarks         String?
  
  // Dates
  issueDate       DateTime     @default(now())
  returnDate      DateTime?    // Null means currently out
  
  status          String       @default("ISSUED") // "ISSUED", "RETURNED"
}


// ==========================================
// GENERIC CALCULATION (Roman/Blinds)
// ==========================================

model Calculation {
  id          String            @id @default(uuid())
  selectionId String            @unique
  selection   Selection         @relation(fields: [selectionId], references: [id], onDelete: Cascade)
  items       CalculationItem[]
  created_at  DateTime          @default(now())
  updated_at  DateTime          @updatedAt
}

model CalculationItem {
  id            String      @id @default(uuid())
  calculationId String
  calculation   Calculation @relation(fields: [calculationId], references: [id], onDelete: Cascade)

  selectionItemId String
  selectionItem   SelectionItem @relation(fields: [selectionItemId], references: [id], onDelete: Cascade)

  category String @default("Standard")
  type     String @default("Local")

  panna   Float @default(0)
  channel Float @default(0)
  fabric  Float @default(0)
  part    Float @default(0)
  sqft    Float @default(0)

  // âœ… ADD THESE MISSING FIELDS
  sqftRate    Float @default(0)
  labourRate  Float @default(0)
  fittingRate Float @default(0)
  fabricRate  Float @default(0)
  channelRate Float @default(0)

  hasBlackout Boolean @default(false)
  blackout    Float   @default(0)

  hasSheer Boolean @default(false)
  sheer    Float   @default(0)

  weightChain Float @default(0)
}

// ==========================================
// LOCAL COMPANY CALCULATION
// ==========================================

model LocalCalculation {
  id          String                 @id @default(uuid())
  selectionId String                 @unique
  selection   Selection              @relation(fields: [selectionId], references: [id], onDelete: Cascade)
  items       LocalCalculationItem[]
  created_at  DateTime               @default(now())
  updated_at  DateTime               @updatedAt
}

model LocalCalculationItem {
  id            String           @id @default(uuid())
  calculationId String
  calculation   LocalCalculation @relation(fields: [calculationId], references: [id], onDelete: Cascade)

  selectionItemId String
  selectionItem   SelectionItem @relation(fields: [selectionItemId], references: [id], onDelete: Cascade)

  // Quantities
  panna   Float @default(0)
  channel Float @default(0)
  fabric  Float @default(0)
  labour  Float @default(0)
  fitting Float @default(0)

  // Rates
  fabricRate   Float @default(0)
  blackoutRate Float @default(0)
  sheerRate    Float @default(0)
  channelRate  Float @default(0)
  labourRate   Float @default(0)
  fittingRate  Float @default(0)

  // Toggles & Extras
  hasBlackout Boolean @default(false)
  blackout    Float   @default(0)

  hasSheer Boolean @default(false)
  sheer    Float   @default(0)

  weightChain Float @default(0)
}

// ==========================================
// FOREST COMPANY CALCULATION
// ==========================================

model ForestCalculation {
  id          String                  @id @default(uuid())
  selectionId String                  @unique
  selection   Selection               @relation(fields: [selectionId], references: [id], onDelete: Cascade)
  items       ForestCalculationItem[]
  created_at  DateTime                @default(now())
  updated_at  DateTime                @updatedAt
}
model ForestCalculationItem {
  id              String            @id @default(uuid())
  calculationId   String
  calculation     ForestCalculation @relation(fields: [calculationId], references: [id], onDelete: Cascade)

  selectionItemId String
  selectionItem   SelectionItem     @relation(fields: [selectionItemId], references: [id], onDelete: Cascade)

  trackType   String @default("white")
  trackPrice  Float  @default(0)
  runnerType  String @default("FES BASE AND FLEX HOOK")
  runnerPrice Float  @default(0)
  tapeType    String @default("FLEX TAPE TRANSPARENT")
  tapePrice   Float  @default(0)

  motorType  String @default("none")
  remoteType String @default("none")

  motorPrice  Float @default(0)
  motorGst    Float @default(0)
  remotePrice Float @default(0)

  totalBeforeGst Float @default(0)
  gst            Float @default(0)

  // âœ… ADD THESE 3 NEW FIELDS
  trackFinal     Float @default(0)
  motorFinal     Float @default(0)
  remoteFinal    Float @default(0)
}

// ==========================================
// SOMFY COMPANY CALCULATION (NEW)
// ==========================================

model SomfyCalculation {
  id          String                 @id @default(uuid())
  selectionId String                 @unique
  selection   Selection              @relation(fields: [selectionId], references: [id], onDelete: Cascade)
  items       SomfyCalculationItem[]
  created_at  DateTime               @default(now())
  updated_at  DateTime               @updatedAt
}
// [UPDATE THIS MODEL IN schema.prisma]
model SomfyCalculationItem {
  id              String           @id @default(uuid())
  calculationId   String
  calculation     SomfyCalculation @relation(fields: [calculationId], references: [id], onDelete: Cascade)

  selectionItemId String
  selectionItem   SelectionItem    @relation(fields: [selectionItemId], references: [id], onDelete: Cascade)

  trackType  String @default("Ripple")
  trackDuty  String @default("Medium")
  trackPrice Float  @default(0)

  motorName  String?
  motorPrice Float   @default(0)

  remoteName  String?
  remotePrice Float   @default(0)

  rippleTapePrice Float @default(0)
  totalPrice      Float @default(0)

  // âœ… ADD THESE 3 NEW FIELDS
  trackFinal      Float @default(0)
  motorFinal      Float @default(0)
  remoteFinal     Float @default(0)
}

// [APPEND TO schema.prisma]

// ==========================================
// QUOTATION MANAGEMENT (UPDATED)
// ==========================================
// Update the Quotation model in schema.prisma

enum QuotationType {
  simple
  detailed
}

// [UPDATE YOUR EXISTING Quotation MODEL]
model Quotation {
  id                   String   @id @default(uuid())
  quotation_number     String   @unique
  quotationType        QuotationType @default(detailed)

  selectionId          String?
  selection            Selection? @relation(fields: [selectionId], references: [id])

  date                 DateTime @default(now())
  status               String   @default("draft")

  // Client Details
  clientName           String
  clientAddress        String?

  // Financials
  subTotal             Float @default(0)
  discountTotal        Float @default(0)
  taxableValue         Float @default(0)
  gstTotal             Float @default(0)
  transportationCharge Float @default(0)
  installationCharge   Float @default(0)
  grandTotal           Float @default(0)

  items                QuotationItem[]

  created_by_id        String
  created_by           User   @relation(fields: [created_by_id], references: [id])

  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  // === ðŸ†• NEW PIPELINE FIELDS ===
  stage       String    @default("Draft") // "Draft", "Sent", "Negotiation", "Approved", "Rejected"
  priority    String    @default("Medium") // "High", "Medium", "Low"

  comments    QuotationComment[]
  checklists  QuotationChecklist[]
  labels      QuotationLabel[]
}

// [ADD THESE NEW MODELS AT THE BOTTOM OF THE FILE]

model QuotationComment {
  id            String    @id @default(uuid())
  content       String
  attachmentUrl String?
  createdAt     DateTime  @default(now())
  
  quotationId   String
  quotation     Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  
  userId        String
  user          User      @relation(fields: [userId], references: [id])
}

model QuotationLabel {
  id          String    @id @default(uuid())
  text        String
  color       String
  
  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
}

model QuotationChecklist {
  id          String    @id @default(uuid())
  title       String
  
  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  
  items       QuotationChecklistItem[]
}

model QuotationChecklistItem {
  id          String             @id @default(uuid())
  text        String
  isCompleted Boolean            @default(false)
  
  checklistId String
  checklist   QuotationChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
}
model QuotationItem {
  id          String    @id @default(uuid())
  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)

  srNo        Int     @default(0)
  description String
  quantity    Float   @default(1)
  unit        String  @default("Nos")
  
  unitPrice   Float   @default(0)
  
  // Discount
  discountPercent Float @default(0)
  discountAmount  Float @default(0)

  // Tax
  gstPercent  Float @default(0)
  gstAmount   Float @default(0)

  // Subtotal & Final
  subtotal     Float   @default(0) // Qty Ã— UnitPrice
  taxableValue Float   @default(0) // subtotal - discountAmount
  total        Float   @default(0) // taxableValue + gstAmount

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model QuotationCounter {
  id         String   @id @default(uuid())
  year_month String   @unique
  counter    Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}


model ActivityLog {
  id        String   @id @default(uuid())
  userId    String
  action    String   // CREATE, UPDATE, DELETE, LOGIN
  entity    String   // SELECTION, PRODUCT, COMPANY, etc.
  entityId  String?  // ID of the specific item
  details   String?  // Description of what changed
  createdAt DateTime @default(now())
}
